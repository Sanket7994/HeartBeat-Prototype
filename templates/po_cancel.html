<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PAYMENT DECLINED</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="vh-100 d-flex justify-content-center align-items-center">
      <div class="col-md-4">
        <div class="border border-3 border-danger"></div>
        <div class="card bg-white shadow p-5">
          <div class="mb-4 text-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="text-danger"
              width="75"
              height="75"
              fill="currentColor"
              class="bi bi-exclamation-circle"
              viewBox="0 0 16 16"
            >
              <path
                d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
              />
              <path
                d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"
              />
            </svg>
          </div>
          <div class="text-center">
            <h1>Transaction Response Pending!</h1>
            <p>
              We regret to inform you that your recent payment for Purchase
              order went through but not reflecting upon the server. Please wait
              for an Update or contact our customer support team at
              admin@yopmail.com for further assistance.
            </p>
            <br />
            {% if error_message %}
            <div class="error-message">
              <p>
                <strong
                  >Error Code:
                  <span id="errorCode">{{ error_message }}</span></strong
                >
              </p>
            </div>
            {% endif %}
            <br />
            <button class="btn btn-outline-success" id="retryPaymentButton">
              Retry Payment
            </button>
            <button class="btn btn-outline-danger" id="exitPageButton">
              Exit Session
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--REDIRECT USER TO SITE PAGE-->
    <script>
      document
        .getElementById("exitPageButton")
        .addEventListener("click", function () {
          // Remove session_id from session storage
          sessionStorage.removeItem("session_id");
          // Redirect the user
          window.location.href =
            "http://127.0.0.1:5502/template/pages/samples/view-purchase-orders.html";
        });
    </script>

    <!--RETRY PAYMENT-->
    <script>
      document
        .getElementById("retryPaymentButton")
        .addEventListener("click", function () {
          // Get the full URL
          var fullURL = window.location.href;
          // Extract the query string from the URL
          var purchaseOrderId = fullURL.split("/")[1];

          const getPurchaseOrderData = (purchaseOrderId) => {
            fetch(
              `http://127.0.0.1:8000/seller/${purchaseOrderId}/initiate-payment`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
              }
            )
              .then((response) => response.json())
              .then((data) => {
                console.log("API response: " + JSON.stringify(data));
                const payment_url = data["payment_link"];
                const checkout_session_id = data["checkout_session_id"];
                const purchase_order_id = data["purchase_order_id"];

                // storing session id to session storage
                sessionStorage.setItem("session_id", checkout_session_id);

                if (payment_url) {
                  window.location.href = payment_url;
                } else {
                  console.error("Payment link invalid or missing");
                }
              })
              .catch((error) => {
                console.error("Error during fetch:", error);
              });
          };
          // Call the function to initiate payment
          getPurchaseOrderData(purchaseOrderId);
        });
    </script>
  </body>
</html>
