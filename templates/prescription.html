<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"
        integrity="sha256-c9vxcXyAG4paArQG3xk6DjyW/9aHxai2ef9RpMWO44A=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>

    <!-- html2canvas library -->
    <script src="js/html2canvas.min.js"></script>

    <!-- jsPDF library -->
    <script src="js/jsPDF/dist/jspdf.umd.js"></script>

    <title>PRESCRIPTION TEMPLATE</title>
    <!--STYLE CSS-->
    <style>
        body {
            background: #c6c4c4;
            margin-top: 20px;
        }

        .text-danger strong {
            color: #9f181c;
        }

        .receipt-main {
            background: #ffffff none repeat scroll 0 0;
            border-bottom: 12px solid #333333;
            border-top: 12px solid #9f181c;
            margin-top: 50px;
            margin-bottom: 50px;
            padding: 40px 30px !important;
            position: relative;
            box-shadow: 0 1px 21px #acacac;
            color: #333333;
            font-family: open sans;
        }

        .receipt-main p {
            color: #333333;
            font-family: open sans;
            line-height: 1.42857;
        }

        .receipt-footer h1,
        .receipt-footer input[type="text"] {
            font-size: 15px;
            font-weight: 400 !important;
            margin: 0 !important;
        }

        .receipt-main::after {
            background: #414143 none repeat scroll 0 0;
            content: "";
            height: 5px;
            left: 0;
            position: absolute;
            right: 0;
            top: -13px;
        }

        .receipt-main thead {
            background: #414143 none repeat scroll 0 0;
        }

        .receipt-main thead th {
            color: #fff;
        }

        .receipt-right h5 {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 7px 0;
        }

        .receipt-right p {
            font-size: 12px;
            margin: 0px;
        }

        .receipt-right p i {
            text-align: center;
            width: 18px;
        }

        .receipt-main td {
            padding: 9px 20px !important;
        }

        .receipt-main th {
            padding: 13px 20px !important;
        }

        .receipt-main td {
            font-size: 13px;
            font-weight: initial !important;
        }

        .receipt-main td p:last-child {
            margin: 0;
            padding: 0;
        }

        .receipt-main td h2 {
            font-size: 20px;
            font-weight: 900;
            margin: 0;
            text-transform: uppercase;
        }

        .receipt-header-mid .receipt-left h1 {
            font-weight: 100;
            margin: 34px 0 0;
            text-align: right;
            text-transform: uppercase;
        }

        #container {
            background-color: #dcdcdc;
        }
    </style>

</head>

<body>
    <div id="printableArea">
        <div class="container" style="height: 1200px; width: 950px;">
            <div class="col-md-12">
                <div class="row">
                    <div
                        class="receipt-main col-xs-10 col-sm-10 col-md-6 col-xs-offset-1 col-sm-offset-1 col-md-offset-3">
                        <div style="display: flex; justify-content: space-between;">
                            <div class="row"
                                style="display: flex; flex-direction: column; justify-content: space-between;">
                                <div class="receipt-header">
                                    <div class="col-xs-6 col-sm-6 col-md-6">
                                        <div class="receipt-left">
                                            <img class="img-responsive" src="./static/output-onlinepngtools (1).png"
                                                style="width: 400px; height: 100px;">
                                        </div>
                                    </div>
                                    <div class="col-xs-6 col-sm-6 col-md-6 text-right">
                                        <div class="receipt-right">
                                            <h2 id="clinic_name" class="clinic-heading"></h2>
                                            <p id="clinic_contact_number" class="clinic-info"><i
                                                    class="fa fa-phone"></i>
                                            </p>
                                            <p id="clinic_email" class="clinic-info"><i class="fa fa-envelope-o"></i>
                                            </p>
                                            <p id="clinic_address" class="clinic-info"><i
                                                    class="fa fa-location-arrow"></i>,
                                            </p>
                                            <p id="clinic_city" class="clinic-info">,</p>
                                            <p id="clinic_country" class="clinic-info"> - Zipcode:
                                            <p id="clinic_zipcode"></p>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row"
                                style="display: flex; flex-direction: column; justify-content: space-between;">
                                <div class="receipt-header receipt-header-mid">
                                    <div class="col-xs-8 col-sm-8 col-md-8 text-left">
                                        <div class="col-xs-4 col-sm-4 col-md-4">
                                            <h2 style="font-size: 22px;">
                                                PRESCRIPTION ID# <input type="text" id="prescription_id"
                                                    style="height: 22px; font-size: 15px; width: 120px;" maxlength="12">
                                            </h2>
                                        </div>
                                        <br>
                                        <div class="receipt-right">
                                            <h5>PATIENT DETAILS</h5>
                                            <p><b>Name :</b> <span id="patient_name"></span></p>
                                            <p><b>Gender :</b> <span id="patient_gender"></span></p>
                                            <p><b>Age :</b> <span id="patient_age"></span> years</p>
                                            <p><b>Appointment Date :</b> <span id="appointment_date"></span></p>
                                            <p><b>Mobile :</b><span id="patient_contact_number"></span> </p>
                                            <p><b>Recurring Patient :</b> <span id="recurring_patient"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <br>
                        <div>
                            <table class="table table-bordered"
                                style="width: 100%; border: 1px solid rgb(208, 207, 207); border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;">Medication Name</th>
                                        <th style="width: 30%;">Purpose</th>
                                        <th style="width: 10%;">Frequency</th>
                                        <th style="width: 10%;">Quantity</th>
                                        <th style="width: 20%;">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="prescriptionTableBody">
                                </tbody>
                                <tbody>
                                    <tr>
                                        <td class="text-right" style="text-align: right;">
                                            <p>
                                                <strong>Medicine Amount: </strong>
                                            </p>
                                            <p>
                                                <strong>Appointment Fees: </strong>
                                            </p>
                                            <p>
                                                <strong>Coupon Discount: </strong>
                                            </p>
                                            <p>
                                                <strong>Tax: </strong>
                                            </p>
                                        <td>
                                            <p>
                                                <i class="fa fa-usd" aria-hidden="true"></i>
                                                <strong id="med_bill_amount"></strong>
                                            </p>
                                            <p>
                                                <i class="fa fa-usd" aria-hidden="true"></i>
                                                <strong id="appointment_fee"></strong>
                                            </p>
                                            <p>
                                                -<i class="fa fa-usd" aria-hidden="true"></i>
                                                <strong id="applied_discount_coupon"></strong>
                                            </p>
                                            <p>
                                                <i class="fa fa-usd" aria-hidden="true"></i>
                                                <strong id="tax_deduction"></strong>
                                            </p>
                                        </td>
                                    </tr>
                                    <tr style="width: 100%;">
                                        <td class="text-right"
                                            style="width: 85%; text-align: right; border: 1px solid rgb(208, 207, 207); border-collapse: collapse;">
                                            <h2><strong>Total Payable Amount: </strong></h2>
                                        </td>
                                        <td class="text-left text-danger"
                                            style="width: 15%; border: 1px solid rgb(208, 207, 207); border-collapse: collapse;">
                                            <h2 style="color: firebrick;"><i class="fa fa-usd"
                                                    aria-hidden="true"></i><strong id="grand_total"></strong></h2>
                                            </h2>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <h3>ADDITIONAL ADVICE: </b><span id="prescription_note" style="font-size: 15px;"></span></h5>
                            <br>
                            <div class="row">
                                <div style="display: flex; justify-content: space-between;">
                                    <div class="col-xs-8 col-sm-8 col-md-8 text-left">
                                        <div class="receipt-right">
                                            <h3>Dr. <span id="consultant_name"></span></h3>
                                            <p id="consultant_designation"></p>
                                            <p id="consultant_contact_number"><i class="fa fa-phone"></i></p>
                                            <p id="consultant_email"><i class="fa fa-envelope-o"></i></p>
                                            <p style="text-align: left;">
                                                <img id="signatureImageElement" src=""
                                                    style="width: 100px; height: 50px;">
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-xs-4 col-sm-4 col-md-4">
                                        <div class="receipt-left">
                                            <h3>SEAL OF AUTHORIZATION</h3>
                                            <p style="text-align: center;">
                                                <img id="imageElement" src="" alt="Authorized Image"
                                                    style="width: 150px; height: 140px;">
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <br>
                            <br>
                            <div class="row">
                                <div class="receipt-header receipt-header-mid receipt-footer"
                                    style="display: flex; justify-content: space-between;">
                                    <div class="col-xs-8 col-sm-8 col-md-8 text-left">
                                        <div class="receipt-right">
                                            <p id="created_at"><b>Date :</b> </p>
                                            <h5 style="color: rgb(78, 98, 196);">Thanks for Visiting.!</h5>
                                        </div>
                                    </div>
                                    <div class="page-tools">
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-success" id="printButton">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"
                                                    fill="currentColor" class="bi bi-printer-fill" viewBox="0 0 16 16">
                                                    <path
                                                        d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z">
                                                    </path>
                                                    <path
                                                        d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z">
                                                    </path>
                                                </svg>
                                                Print
                                            </button>
                                            <button type="button" class="btn btn-success"
                                                onclick="Convert_HTML_To_PDF();">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"
                                                    fill="currentColor" class="bi bi-filetype-pdf" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd"
                                                        d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM1.6 11.85H0v3.999h.791v-1.342h.803c.287 0 .531-.057.732-.173.203-.117.358-.275.463-.474a1.42 1.42 0 0 0 .161-.677c0-.25-.053-.476-.158-.677a1.176 1.176 0 0 0-.46-.477c-.2-.12-.443-.179-.732-.179Zm.545 1.333a.795.795 0 0 1-.085.38.574.574 0 0 1-.238.241.794.794 0 0 1-.375.082H.788V12.48h.66c.218 0 .389.06.512.181.123.122.185.296.185.522Zm1.217-1.333v3.999h1.46c.401 0 .734-.08.998-.237a1.45 1.45 0 0 0 .595-.689c.13-.3.196-.662.196-1.084 0-.42-.065-.778-.196-1.075a1.426 1.426 0 0 0-.589-.68c-.264-.156-.599-.234-1.005-.234H3.362Zm.791.645h.563c.248 0 .45.05.609.152a.89.89 0 0 1 .354.454c.079.201.118.452.118.753a2.3 2.3 0 0 1-.068.592 1.14 1.14 0 0 1-.196.422.8.8 0 0 1-.334.252 1.298 1.298 0 0 1-.483.082h-.563v-2.707Zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638H7.896Z">
                                                    </path>
                                                </svg>
                                                Download
                                            </button>
                                            <button type="button" class="btn btn-success"
                                                onclick="location.href='https://support.google.com/mail/thread/144814712/gmail-login?hl=en'">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"
                                                    fill="currentColor" class="bi bi-envelope-at" viewBox="0 0 16 16">
                                                    <path
                                                        d="M2 2a2 2 0 0 0-2 2v8.01A2 2 0 0 0 2 14h5.5a.5.5 0 0 0 0-1H2a1 1 0 0 1-.966-.741l5.64-3.471L8 9.583l7-4.2V8.5a.5.5 0 0 0 1 0V4a2 2 0 0 0-2-2H2Zm3.708 6.208L1 11.105V5.383l4.708 2.825ZM1 4.217V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v.217l-7 4.2-7-4.2Z" />
                                                    <path
                                                        d="M14.247 14.269c1.01 0 1.587-.857 1.587-2.025v-.21C15.834 10.43 14.64 9 12.52 9h-.035C10.42 9 9 10.36 9 12.432v.214C9 14.82 10.438 16 12.358 16h.044c.594 0 1.018-.074 1.237-.175v-.73c-.245.11-.673.18-1.18.18h-.044c-1.334 0-2.571-.788-2.571-2.655v-.157c0-1.657 1.058-2.724 2.64-2.724h.04c1.535 0 2.484 1.05 2.484 2.326v.118c0 .975-.324 1.39-.639 1.39-.232 0-.41-.148-.41-.42v-2.19h-.906v.569h-.03c-.084-.298-.368-.63-.954-.63-.778 0-1.259.555-1.259 1.4v.528c0 .892.49 1.434 1.26 1.434.471 0 .896-.227 1.014-.643h.043c.118.42.617.648 1.12.648Zm-2.453-1.588v-.227c0-.546.227-.791.573-.791.297 0 .572.192.572.708v.367c0 .573-.253.744-.564.744-.354 0-.581-.215-.581-.8Z" />
                                                </svg>
                                                Email
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script async>
        const searchStr = window.location.search

        // AVOIDING GETTING PRINT PROMT WHENEVER PAGE RELOADS
        document.getElementById("printButton").addEventListener("click", function () {
            printPage();
        });
        function printPage() {
            // Print the page
            window.print();
        }
        // Add event listener to handle dropdown change and Enter key press
        const getAppointmentData = (prescription_id) => {
            fetch(`http://127.0.0.1:8000/prescription/download/${prescription_id}/`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    // Handle the response from the API
                    basicData = data;
                    console.log(data);
                    let masterDATA = data.masterData;
                    console.log(masterDATA);

                    // Access the data and update HTML elements
                    // CLINIC DATA
                    document.getElementById("clinic_name").textContent = masterDATA.clinic_name;
                    document.getElementById("clinic_address").textContent = masterDATA.clinic_address;
                    document.getElementById("clinic_city").textContent = masterDATA.clinic_city;
                    document.getElementById("clinic_country").textContent = masterDATA.clinic_country;
                    document.getElementById("clinic_zipcode").textContent = masterDATA.clinic_zipcode;
                    document.getElementById("clinic_contact_number").textContent = masterDATA.clinic_contact_number;
                    document.getElementById("clinic_email").textContent = masterDATA.clinic_email;
                    // CONSULTANT DATA
                    document.getElementById("consultant_name").textContent = `${masterDATA.staff_first_name} ${masterDATA.staff_last_name}`;
                    document.getElementById("consultant_designation").textContent = masterDATA.staff_designation;
                    document.getElementById("consultant_email").textContent = masterDATA.staff_email;
                    document.getElementById("consultant_contact_number").textContent = masterDATA.staff_contact_number;
                    // PATIENT DATA
                    document.getElementById("patient_name").textContent = `${masterDATA.patient_first_name} ${masterDATA.patient_last_name}`;
                    document.getElementById("patient_gender").textContent = masterDATA.patient_gender;
                    document.getElementById("patient_age").textContent = masterDATA.patient_age;
                    document.getElementById("recurring_patient").textContent = masterDATA.recurring_patient;
                    document.getElementById("appointment_date").textContent = masterDATA.appointment_date;
                    document.getElementById("patient_contact_number").textContent = masterDATA.patient_contact_number;
                    // PRESCRIPTION AND PROCEDURE DATA
                    document.getElementById("prescription_note").textContent = masterDATA.description;
                    document.getElementById("med_bill_amount").textContent = masterDATA.med_bill_amount;
                    document.getElementById("appointment_fee").textContent = masterDATA.appointment_fee;
                    document.getElementById("applied_discount_coupon").textContent = masterDATA.coupon_discount;
                    document.getElementById("tax_deduction").textContent = "18%";
                    document.getElementById("grand_total").textContent = masterDATA.grand_total;

                    // Fetching prescription approval status
                    const approval_status = masterDATA.approval_status;

                    // Function 
                    function uploadImageByStatus(approval_status) {
                        const imageElement = document.getElementById("imageElement");
                        const signatureImageElement = document.getElementById("signatureImageElement");
                        console.log("imageElement");

                        if (approval_status === "PENDING") {
                            const imageSrc = "./static/pending-red-stamp.jpg";
                            imageElement.src = imageSrc;
                        } else if (approval_status === "APPROVED") {
                            const imageSrc = "./static/seal_of_approval.jpg";
                            imageElement.src = imageSrc;
                            const signatureImageSrc = "./static/stock_signature.png";
                            signatureImageElement.src = signatureImageSrc;
                        }
                    }
                    // Calling the function
                    uploadImageByStatus(approval_status);

                    // CONVERTING DATE TIME TO EASY TO READ FORMAT
                    const date = new Date(masterDATA.created_at);

                    const options = {
                        day: 'numeric',
                        weekday: 'short',
                        month: 'short',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric'
                    };
                    const formattedDate = date.toLocaleString('en-US', options);
                    document.getElementById("created_at").textContent = formattedDate;

                    // LOOPING DATA COLLECTED FROM API TO FILL THE TABLE
                    let tbody = '';
                    const get_table = document.getElementById("prescriptionTableBody");

                    for (const obj of data.masterData.prescribed_meds) {
                        const table_row = `
                        <tr>
                            <td>${obj.medicine_name}</td>
                            <td>${obj.medicine_purpose}</td>
                            <td>${obj.dosage_freq}</td>
                            <td>${obj.quantity} Nos</td>
                            <td><i class="fa fa-usd" aria-hidden="true"></i>${obj.total_payable_amount}</td>
                        </tr>`;
                        tbody += table_row;
                    }
                    get_table.innerHTML = tbody;
                });
        };

        // Getting data via url parameter
        if(searchStr){
            const d_ = window.location.search.replace('?','').split('=')
            getAppointmentData(d_[1])
        }
    </script>

    <!--ENABLES USER TO DOWNLOAD HTML PAGE AS PDF-->
    <script>
        window.jsPDF = window.jspdf.jsPDF;

        // Convert HTML content to PDF
        function Convert_HTML_To_PDF() {
            console.log("Triggered")
            var doc = new jsPDF();

            // Source HTMLElement or a string containing HTML.
            var elementHTML = document.querySelector("#printableArea");

            doc.html(elementHTML, {
                callback: function (doc) {
                    // Save the PDF
                    var file_name = "Prescription_" + prescription_id.value + ".pdf";
                    doc.save(file_name);
                },
                margin: [10, 10, 10, 10],
                autoPaging: 'text',
                x: 0,
                y: 0,
                width: 190, //target width in the PDF document
                windowWidth: 675 //window width in CSS pixels
            });
        }
    </script>
</body>
</html>